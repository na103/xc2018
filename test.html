<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Test Suite</title>
    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.11.2.css">
  </head>
  <body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="https://code.jquery.com/qunit/qunit-2.11.2.js"></script>
    <script src="draw.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <div id="result"></div>
</body>

<script>
  function mkBitstream() {
    let bitstream = new Array(160);
    for (var x = 0; x < 160; x++) {
      bitstream[x] = new Array(71);
    }
    return bitstream;
  }

  function formula4(nf, f1, f2, f3, f4) {
    return nf + f1 + ' ' + f2 + ' ' + f3 + ' ' + f4;
  }

  function formula3(nf, f1, f2, f3) {
    return nf + f1 + ' ' + f2 + ' ' + f3;
  }

  QUnit.module('draw', { beforeEach: function() {
      initNames();
  }}, function() {

    QUnit.test('test initNames', function(assert) {
      assert.deepEqual(colInfo['col.A.local.1'], [5, 26], 'col.A.local.1');
    });

    QUnit.test('test pip', function(assert) {
      bitstream = mkBitstream();
      let pip = new Pip('col.A.long.2:row.A.local.5', [100, 50]);
      bitstream[100][50] = 1;
      pip.decode(bitstream);
      assert.deepEqual(pip.state, 1);

      bitstream[100][50] = 0;
      pip.decode(bitstream);
      assert.deepEqual(pip.state, 0);
    });

    QUnit.test('validate tile coords', function(assert) {
      initTiles();

      assert.deepEqual(tiles[0][0].screenPt, [78, 68]);
      assert.deepEqual(tiles[0][3].screenPt, [78, 284]);
      assert.deepEqual(tiles[0][8].screenPt, [78, 644]);
      assert.deepEqual(tiles[5][0].screenPt, [438, 68]);
      assert.deepEqual(tiles[5][7].screenPt, [438, 572]);
      assert.deepEqual(tiles[5][8].screenPt, [438, 644]);
      assert.deepEqual(tiles[8][0].screenPt, [654, 68]);
      assert.deepEqual(tiles[8][4].screenPt, [654, 356]);
      assert.deepEqual(tiles[8][8].screenPt, [654, 644]);

      assert.deepEqual(tiles[0][0].gPt, [0, 0]);
      assert.deepEqual(tiles[0][3].gPt, [0, 60]);
      assert.deepEqual(tiles[0][8].gPt, [0, 160]);
      assert.deepEqual(tiles[5][0].gPt, [95, 0]);
      assert.deepEqual(tiles[5][7].gPt, [95, 140]);
      assert.deepEqual(tiles[5][8].gPt, [95, 160]);
      assert.deepEqual(tiles[8][0].gPt, [152, 0]);
      assert.deepEqual(tiles[8][4].gPt, [152, 80]);
      assert.deepEqual(tiles[8][8].gPt, [152, 160]);

      assert.deepEqual(tiles[0][0].bitPt, [3, 1]);
      assert.deepEqual(tiles[0][3].bitPt, [3, 26]);
      assert.deepEqual(tiles[0][8].bitPt, [3, 67]);
      assert.deepEqual(tiles[5][0].bitPt, [95, 1]);
      assert.deepEqual(tiles[5][7].bitPt, [95, 59]);
      assert.deepEqual(tiles[5][8].bitPt, [95, 67]);
      assert.deepEqual(tiles[8][0].bitPt, [151, 1]);
      assert.deepEqual(tiles[8][4].bitPt, [151, 34]);
      assert.deepEqual(tiles[8][8].bitPt, [151, 67]);
    });

    // Reads all the SWn.RBT files and makes sure the appropriate Switch pins are connected.
    QUnit.test('switch files', function(assert) {
      let done = assert.async(120)
      for (var i = 0; i < 120; i++) {
        // These are all asynchronous because of the file fetching.
        // done() must be called filenames.length times for the test to complete.
        testSwitchFile('SWITCH' + i, assert, done);
      }
    });

    // Test the named file.
    function testSwitchFile(name, assert, done) {
      $.get( 'testfiles/' + name + '.RBT', function(rbt, status) {
        assert.equal(status, "success");
        $.get( 'testfiles/' + name + '.LCA', function(lca, status) {
          assert.equal(status, "success");
          // loaded rbt and lca
          let m = lca.match(/^;([^:]+):/)
          assert.ok(m);
          let sw = m[1]; // e.g "AC.8.1.5 AC.8.1.6"
          let pin1 = parseInt(sw[7]);
          let pin2 = parseInt(sw[16]);
          let x = sw.charCodeAt(1) - "A".charCodeAt(0);
          let y = sw.charCodeAt(0) - "A".charCodeAt(0);

          let tile = new Tile(x, y);
          let bitstream = rbtParse(rbt);
          tile.decode(bitstream);
          if (sw[5] == 1) {
            // Switch 1 has a wire
            assert.deepEqual(tile.switch1.wires, [[pin1, pin2]]);
            assert.deepEqual(tile.switch2.wires, []);
          } else if (sw[5] == 2) {
            // Switch 2 has a wire
            assert.deepEqual(tile.switch1.wires, []);
            assert.deepEqual(tile.switch2.wires, [[pin1, pin2]]);
          } else {
            assert.ok(false);
          }
          done();
        });
      });
    }

  });
</script>


</html>
