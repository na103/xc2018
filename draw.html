<html>
  <!--

  View coordinate data.
  -->
<head>
  <!--
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
-->
<script src="jquery.min.js"></script>
<script src="draw.js"></script>
<script src="data.js"></script>
<script src="formula.js"></script>
<script src="bitstreamDisplay.js"></script>

<script>
$(document).ready(function() {
  window.onerror = function errorHandler(msg, url, line) {
    alert('Exception ' + msg + ' ' + url + ' ' + line);
    error('Exception ' + msg + ' ' + url + ' ' + line);
    return false;
  }

  // https://makitweb.com/drag-and-drop-file-upload-with-jquery-and-ajax/

  $("html").on("dragover", function(e) {
    e.preventDefault();
    e.stopPropagation();
  });

  $("html").on("drop", function (e) {
    e.preventDefault();
    e.stopPropagation();
    var files = e.originalEvent.dataTransfer.files;

    if (files.length != 1) {
      alert('Unexpected upload length ' + files.length);
      return;
    }
    var ucname = files[0].name.toUpperCase();
    if (ucname.endsWith('.LCA')) {
      files[0].text().then(lcaUpload);
    } else if (ucname.endsWith('.RBT')) {
      files[0].text().then(rbtUpload);
    } else {
      alert('Need to upload a .RBT or .LCA file.');
    }
  });

  function lcaUpload(contents) {
    $("#info").html('Not implemented');
  }

  $('#mode').on('change', function() {
    redraw(ctx);
  });

  /**
   * Handles the upload of a .RBT file, storing it into the variable bitstream, which has 160 lines of 71 '0'/'1' characters,
   * the contents of the .RBT file.
   */
  function rbtUpload(contents) {
    bitstream = rbtParse(contents);
    $('#mode').css('display', 'block'); // Show the dropdown
    decode(bitstream);
    redraw(ctx);
  }

  function redraw(ctx) {
    if (canvasMode() == 'bitstream') {
      drawBitstream(ctx, bitstream);
    } else if (canvasMode() == 'layout') {
      drawLayout(ctx);
    }
  }

  // Parse Geoff's data
  function loadFile() {
    let defs = new Array(160);
    window.defs = defs;
    for (let x = 0; x < 160; x++) {
      defs[x] = new Array(71);
    }
    $.get('XC2064-def.txt', function(data) {
      const lines = data.match(/[^\r\n]+/g);
      lines.forEach(function(l) {
        const m = l.match(/Bit:\s+(\S+) (.*)/);
        if (m) {
          const addr = parseInt(m[1], 16);
          const val = m[2];
          let x = 159 - Math.trunc(addr / 71);
          let y = 70 - (addr % 71);
          defs[x][y] = val;
        }
      });
    }, 'text');
  }




  // Returns bitstream or layout
  function canvasMode() {
    return $("#mode").val();
  }

  $("#canvas").mousemove(function(e) {
    var offset = $(this).offset();
    var x = e.pageX - offset.left;
    var y = e.pageY - offset.top;
    if (canvasMode() == 'bitstream') {
      bitstreamClick(x, y);
    } else {
      layoutClick(x, y);
    }
  });

  var ctx = $("#canvas")[0].getContext("2d");
  var ctx2 = $("#canvas2")[0].getContext("2d");

  $("#demo").click(function() {
    bitstream = makeDemoBitstream();
    $('#mode').css('display', 'block'); // Show the dropdown
    decode(bitstream);
    $("#mode").val("bitstream");
    redraw(ctx);
  });

  loadFile();
  init();
  drawLayout(ctx);


});

</script>
<title>FPGA viewer: draw</title>
</head>
<body>
<div id="header">
<select id="mode" style="display:none"><option value="layout" selected>Layout</option><option value="bitstream">Bitstream</option></select>
<button id="demo">Demo</button>
<span id="bitstreamSpan" style="display:none">
<input type="checkbox" id="labels" value="Labels" checked>Labels</input>
<input type="checkbox" id="colors" value="Colors">Colors</input>
</span>
</div>
<div id="info"></div>
<div id="info2"> </div>
<div id="container" style="position: relative; float: left;">
  <canvas style="position:absolute; z-index: 1" id="canvas"></canvas>
  <img style="display:xnone" id="img" style="position:absolute" src="pips.png" width=680 height=680></img>
</div>
<div id="info3"> </div>
<canvas id="canvas2" width=300 height=300></canvas>
</body>
</html>
