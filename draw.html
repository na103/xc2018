<html>
  <!--

  View coordinate data.
  -->
<head>
  <!--
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
-->
<script src="jquery.min.js"></script>
<script src="draw.js"></script>
<script src="data.js"></script>
<script src="formula.js"></script>

<script>
$(document).ready(function() {
  window.onerror = function errorHandler(msg, url, line) {
    alert('Exception ' + msg + ' ' + url + ' ' + line);
    error('Exception ' + msg + ' ' + url + ' ' + line);
    return false;
  }

  // https://makitweb.com/drag-and-drop-file-upload-with-jquery-and-ajax/

  $("html").on("dragover", function(e) {
    e.preventDefault();
    e.stopPropagation();
  });

  $("html").on("drop", function (e) {
    e.preventDefault();
    e.stopPropagation();
    var files = e.originalEvent.dataTransfer.files;

    if (files.length != 1) {
      alert('Unexpected upload length ' + files.length);
      return;
    }
    var ucname = files[0].name.toUpperCase();
    if (ucname.endsWith('.LCA')) {
      files[0].text().then(lcaUpload);
    } else if (ucname.endsWith('.RBT')) {
      files[0].text().then(rbtUpload);
    } else {
      alert('Need to upload a .RBT or .LCA file.');
    }
  });

  function lcaUpload(contents) {
    $("#info").html('LCA: ' + contents);
  }

  $('#mode').on('change', function() {
    redraw(ctx);
  });

  /**
   * Handles the upload of a .RBT file, storing it into the variable bitstream, which has 160 lines of 71 '0'/'1' characters,
   * the contents of the .RBT file.
   */
  function rbtUpload(contents) {
    bitstream = rbtParse(contents);
    decode(bitstream);
    redraw(ctx);
  }

  function redraw(ctx) {
    if (canvasMode() == 'bitstream') {
      drawBitstream(bitstream);
    } else if (canvasMode() == 'layout') {
      drawLayout();
    }
  }


  /**
   * Displays the bitstream data.
   */
  function drawBitstream(bitstream) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    if (bitstream == null) {
      return;
    }

    // Draw labels
    ctx.canvas.height = 570;
    $("#container").css('height', '570px');
    ctx.font = "45pt arial";
    ctx.fillStyle = "#ddf";
    var SIZE = 8; // Each digit is a SIZE x SIZE block.
    var xpos = 3; // 3 bits to first cell.
    ctx.strokeStyle = "#ccc";
    ctx.beginPath();
    ctx.rect(0, 0, 160 * SIZE, 71 * SIZE);
    ctx.stroke();
    ctx.strokeStyle = "#fbb";
    ctx.beginPath();
    for (var x = 0; x < 8; x++) {
      if (x == 3 || x == 6) {
        xpos += 2; // Skip buffer
      }
      var ypos = 1; // 1 bit to first cell
      for (var y = 0; y < 8; y++) {
        if (y == 3 || y == 6) {
          ypos += 1; // Skip buffer
        }
        fillText(ctx, "ABCDEFGH"[y] + "ABCDEFGH"[x], 30 + xpos * SIZE, 52 + ypos * SIZE);
        ctx.rect(xpos * SIZE, ypos * SIZE, 18 * SIZE, 8 * SIZE);
        ypos += 8; // 8 bits per tile
      }
      xpos += 18; // 18 bits per tile
    }
    ctx.stroke();

    // Draw data
    $("#img").css('opacity', 0);
    ctx.font = "9px arial";
    ctx.fillStyle = "black";
    for (var x = 0; x < 160; x++) {
      for (var y = 0; y < 71; y++) {
        fillText(ctx, bitstream[x][y] == 0 ? ' ' : '1', 1 + x * SIZE, 7 + y * SIZE);
      }
    }
  }



  function bitstreamClick(x, y) {
    if (bitstream == null) {
      return;
    }
    var xn = x / 8; // Convert to bit indices
    var yn = y / 8;
    var xinfo = findTileX(xn);
    var yinfo = findTileY(yn);
    if (xinfo[2] >= 0 && yinfo[2] >= 0) {
      $("#info3").html(tiles[xinfo[2]][yinfo[2]].decode(bitstream));
    } else {
      $("#info3").html(x + ' ' + y + ' ' + xinfo + ' ' + yinfo);
    }
  }


  // Returns bitstream or layout
  function canvasMode() {
    return $("#mode").val();
  }

  $("#canvas").mousemove(function(e) {
    var offset = $(this).offset();
    var x = e.pageX - offset.left;
    var y = e.pageY - offset.top;
    if (canvasMode() == 'bitstream') {
      bitstreamClick(x, y);
    }
  });

  var ctx = $("#canvas")[0].getContext("2d");
  var ctx2 = $("#canvas2")[0].getContext("2d");


  function drawLayout() {
    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset
    ctx.canvas.height = 680;
    $("#container").css('height', '680px');
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.translate(0.5, 0.5); // Prevent antialiasing
    ctx.lineWidth = 1;
    ctx.lineCap = 'butt';
    objects.forEach(o => o.draw(ctx));
  }

  function decode(bitstream) {
     var result = [];
     objects.forEach(o => result.push(...o.decode(bitstream)));
     $("#info3").html(result.join('<br/>'));
  }

  init();
  drawLayout();


});

</script>
<title>FPGA viewer: draw</title>
</head>
<body>
<div id="header">
<select id="mode"><option value="layout" selected>Layout</option><option value="bitstream">Bitstream</option></select>
</div>
<div id="info"> </div>
<div id="info2"> </div>
<div id="container" style="position: relative">
  <canvas style="position:absolute; z-index: 1" id="canvas" width=2000 height=2000></canvas>
  <img style="display:none" id="img" style="position:absolute" src="pips.png" width=680 height=680></img>
</div>
<div id="info3"> </div>
<canvas id="canvas2" width=300 height=300></canvas>
</body>
</html>
